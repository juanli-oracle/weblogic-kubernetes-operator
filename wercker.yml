# Copyright 2017, 2018, Oracle Corporation and/or its affiliates.  All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at http://oss.oracle.com/licenses/upl.

#
#  Wercker build file for Oracle WebLogic Server Kubernetes Operator
#

#
#  Wercker application is at : https://app.wercker.com/Oracle/weblogic-kubernetes-operator
#
#  Werkcer workflow looks like this:
#
#  build -> integration-tests (1.7.9)
#        -> integration-tests (1.8.5)
#        -> quality
#

box:
  id: store/oracle/serverjre
  username: $DOCKER_USERNAME
  password: $DOCKER_PASSWORD
  tag: 8

# This is the main build pipeline that builds the codebase and runs unit tests.
build:
  steps:
  - script:
    name: Hello
    code: |
      echo "Building Oracle WebLogic Server Kubernetes Operator..."
      echo "The branch and commit id are $WERCKER_GIT_BRANCH, $WERCKER_GIT_COMMIT"
  - script:
    name: Install pre-reqs
    code: |
      yum -y install tar gzip procps
      cp -r src/resources/* $WERCKER_CACHE_DIR
  - wercker/maven:
    goals: clean install
    version: 3.5.2
    cache_repo: true
  - script:
    name: Copy built-artifacts into the image
    code: |
      mkdir /operator
      mkdir /operator/lib
      cp -R src/scripts/* /operator/
      cp operator/target/weblogic-kubernetes-operator-1.0.jar /operator/weblogic-kubernetes-operator.jar
      cp operator/target/lib/*.jar /operator/lib/
      export IMAGE_TAG_OPERATOR="${IMAGE_TAG_OPERATOR:-${WERCKER_GIT_BRANCH//[_\/]/-}}"
      if [ "$IMAGE_TAG_OPERATOR" = "master" ]; then
        export IMAGE_TAG_OPERATOR="latest"
      fi
  - script:
    name: Remove things we do not want in the Docker image in order to reduce size of image
    code: |
      rpm -e --nodeps tar 
      rpm -e --nodeps gzip 
      yum clean all
      rm -rf /var/cache/yum
  # push the image to Docker using the GIT branch as the tag
  # this image needs to be available to the integration-test pipeline for testing
  - internal/docker-push:
    username: $REPO_USERNAME
    password: $REPO_PASSWORD
    repository: $REPO_REPOSITORY
    registry: $REPO_REGISTRY
    tag: $IMAGE_TAG_OPERATOR
    working-dir: "/operator"
    cmd: "operator.sh"
    env: "PATH=$PATH:/operator"
  - script:
    name: Security Scan
    code: |
      #!/bin/bash
      export PATH=$PATH:$WERCKER_CACHE_DIR
      CLAIR_OUTPUT=High CLAIR_ADDR=http://129.146.68.168:30060 CLAIR_TIMEOUT=10 DOCKER_TIMEOUT=10 DOCKER_USER=juanlioracle DOCKER_PASSWORD=dockerjuanli1 DOCKER_INSECURE=true REGISTRY_INSECURE=true JSON_OUTPUT=true klar-2.0.2-linux-amd64 juanlioracle/weblogic-kubernetes-operator
      echo "% Scan finished"
      trap finish EXIT

dev:
  steps:
  - internal/shell
